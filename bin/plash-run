#!/usr/bin/env python3
#
# usage: plash-run CONTAINER [--upperdir-workdir-pair WORKDIR UPPERDIR] [--mount MOUNTS] [--deescalate-sudo] [CMD1 [CMD2 [CMD3 ...]]
# Run a command inside a container. If no command is specified a shell is
# started.  The workdir and upperdir parameters can be used to save file system
# changes made inside the container.


import os
import sys
from plashlib.utils import nodepath_or_die, handle_help_flag, die_with_usage, handle_build_args, get_plash_data
from subprocess import check_call
from tempfile import mkdtemp

handle_build_args()
handle_help_flag()
try:
    container_id, *cmd = sys.argv[1:]
except ValueError:
    die_with_usage() 

plash_tmp = os.path.join(get_plash_data(), 'tmp')
mountpoint = mkdtemp(dir=plash_tmp, prefix='plash-run-mountpoint-')
changesdir = mkdtemp(dir=plash_tmp, prefix='plash-run-changesdir-')
check_call(['plash-mount', str(container_id), mountpoint, changesdir])

os.execlp(
'plash-chroot',
'plash-chroot',
'--',
mountpoint,
*cmd)
